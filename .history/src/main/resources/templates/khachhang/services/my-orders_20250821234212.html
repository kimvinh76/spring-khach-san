s<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω d·ªãch v·ª• - Hotel Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* SIMPLIFIED CSS - NO COMPLEX ANIMATIONS OR TRANSFORMS */
        body {
            background-color: #f8f9fa;
            padding-top: 80px; /* Add padding for fixed navbar */
        }
        .order-card {
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            opacity: 1 !important;
            transform: none !important;
        }
        .order-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .status-badge {
            font-size: 0.8rem;
        }
        .total-amount {
            font-weight: 700;
            color: #28a745;
            font-size: 1.1rem;
        }
        .booking-selector {
            background: #007bff;
            border: none;
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }
        .payment-summary {
            background: #28a745;
            border: none;
            box-shadow: 0 2px 8px rgba(40,167,69,0.3);
        }
        .service-header {
            background: #007bff;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .btn-custom {
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 600;
        }
        .service-header h2 {
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .empty-state {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div th:replace="~{khachhang/fragments/home-navbar :: navbar}"></div>
    
    <div class="container mt-4">
        <!-- Header -->
        <div class="service-header text-center">
            <h2 class="mb-2">
                <i class="bi bi-gear-fill"></i> Qu·∫£n l√Ω ƒë∆°n h√†ng c·ªßa t√¥i
            </h2>
            <p class="mb-3">Theo d√µi v√† qu·∫£n l√Ω c√°c d·ªãch v·ª• ƒë√£ ƒë·∫∑t cho booking c·ªßa b·∫°n</p>
            
            <!-- Quick Actions -->
            <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
                <a href="/booking/history" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-clock-history"></i> L·ªãch s·ª≠ booking
                </a>
                <a th:if="${selectedBooking != null}" 
                   th:href="@{'/booking/invoice/' + ${selectedBooking.id}}" 
                   class="btn btn-outline-light btn-sm">
                    <i class="bi bi-receipt"></i> H√≥a ƒë∆°n booking n√†y
                </a>
                <a href="/khachhang/services/list" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-list"></i> T·∫•t c·∫£ d·ªãch v·ª•
                </a>
                <a href="/rooms" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-house"></i> ƒê·∫∑t ph√≤ng m·ªõi
                </a>
            </div>
        </div>

        <!-- Booking Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card booking-selector text-white">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-calendar-check"></i> Ch·ªçn ƒë∆°n ƒë·∫∑t ph√≤ng ƒë·ªÉ xem ƒë·∫∑t ph√≤ng d·ªãch v·ª•
                        </h5>
                        <form method="get" action="/khachhang/services/my-orders">
                            <div class="row align-items-end">
                                <div class="col-md-9">
                                    <label for="bookingSelect" class="form-label text-white fw-bold">Booking c·ªßa b·∫°n:</label>
                    <select name="bookingId" id="bookingSelect" class="form-select form-select-lg" 
                        data-debounce="300">
                                        <option value="">üè® -- Ch·ªçn booking ƒë·ªÉ xem d·ªãch v·ª• --</option>
                                        <option th:each="booking : ${paidBookings}"
                                                th:value="${booking.id}"
                                                th:selected="${selectedBooking != null and selectedBooking.id == booking.id}"
                                                th:text="'üõèÔ∏è Booking #' + ${booking.id} + ' - Ph√≤ng ' + 
                                                       (${booking.room != null ? booking.room.name : 'N/A'}) + 
                                                       ' (' + ${booking.status} + ')'">
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button type="submit" id="bookingSubmitBtn" class="btn btn-light btn-lg btn-custom w-100">
                                        <i class="bi bi-search"></i> Xem ƒë∆°n ƒë·∫∑t ph√≤ng v√† d·ªãch v·ª•
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    <!-- Selected Booking Info -->
    <div id="ordersContainer" th:fragment="ordersFragment">
    <!-- Default content for when no booking selected -->
    <div th:unless="${selectedBooking != null}" class="empty-state text-center p-5">
        <i class="bi bi-calendar-check" style="font-size: 4rem; color: #6c757d;"></i>
        <h3 class="mt-3 text-muted">üè® Ch·ªçn booking ƒë·ªÉ b·∫Øt ƒë·∫ßu</h3>
        <p class="text-muted">S·ª≠ d·ª•ng dropdown ·ªü tr√™n ƒë·ªÉ ch·ªçn booking b·∫°n mu·ªën qu·∫£n l√Ω d·ªãch v·ª•</p>
        <div class="alert alert-info mt-3" role="alert">
            <strong>üí° H∆∞·ªõng d·∫´n:</strong> Ch·ªçn m·ªôt booking t·ª´ danh s√°ch tr√™n ƒë·ªÉ xem c√°c d·ªãch v·ª• ƒë√£ ƒë·∫∑t
        </div>
    </div>
    
    <div th:if="${selectedBooking != null}">
        <!-- Booking Info Display -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info d-flex align-items-center">
                    <i class="bi bi-info-circle-fill me-3" style="font-size: 1.5rem;"></i>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            üè® <strong>Booking ƒë∆∞·ª£c ch·ªçn:</strong> #<span th:text="${selectedBooking != null ? selectedBooking.id : 'N/A'}"></span> 
                            - Ph√≤ng <strong th:text="${selectedBooking.room != null ? selectedBooking.room.name : 'N/A'}"></strong>
                        </h6>
                        <small class="text-muted">
                            üìÖ <span th:text="${selectedBooking.checkIn != null ? #temporals.format(selectedBooking.checkIn, 'dd/MM/yyyy') : 'N/A'}"></span> 
                            ƒë·∫øn <span th:text="${selectedBooking.checkOut != null ? #temporals.format(selectedBooking.checkOut, 'dd/MM/yyyy') : 'N/A'}"></span>
                            | Tr·∫°ng th√°i: <span class="badge bg-primary" th:text="${selectedBooking.status ?: 'N/A'}"></span>
                        </small>
                    </div>
                    <div class="d-flex gap-2">
                        <a th:if="${selectedBooking != null}" th:href="@{'/booking/invoice/' + ${selectedBooking.id}}" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-receipt"></i> H√≥a ƒë∆°n
                        </a>
                        <a th:if="${selectedBooking != null}" th:href="@{'/booking/details/' + ${selectedBooking.id}}" 
                           class="btn btn-outline-info btn-sm">
                            <i class="bi bi-eye"></i> Chi ti·∫øt
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Orders Display -->
        <div th:if="${orders == null or #lists.isEmpty(orders)}">
            <div class="empty-state text-center p-5">
                <i class="bi bi-box" style="font-size: 4rem; color: #6c757d;"></i>
                <h3 class="mt-3 text-muted">üì≠ Ch∆∞a c√≥ d·ªãch v·ª•</h3>
                <p class="text-muted">B·∫°n ch∆∞a ƒë·∫∑t d·ªãch v·ª• cho booking n√†y.</p>
                <a th:if="${selectedBooking != null}" th:href="@{/khachhang/services/list(bookingId=${selectedBooking.id})}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> ƒê·∫∑t d·ªãch v·ª• ngay
                </a>
            </div>
        </div>
        
        <div th:if="${orders != null and not #lists.isEmpty(orders)}">
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-success d-flex align-items-center">
                        <i class="bi bi-check-circle-fill me-2" style="font-size: 1.5rem;"></i>
                        <div>
                            <h5 class="mb-1">üéâ D·ªãch v·ª• ƒë√£ ƒë·∫∑t cho Booking <span th:text="|#${selectedBooking.id}|"></span></h5>
                            <small>Ph√≤ng <strong th:text="${selectedBooking.room?.name ?: 'N/A'}"></strong> | T·ªïng <strong th:text="${#lists.size(orders)}"></strong> d·ªãch v·ª•</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Service Orders List -->
            <div class="row">
                <div class="col-lg-6 col-md-6 mb-4" th:each="order : ${orders}">
                    <div class="card order-card h-100 loaded">
                        <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                            <h6 class="mb-0 fw-bold">
                                <i class="bi bi-star-fill"></i> 
                                <span th:text="${order.serviceName ?: 'N/A'}"></span>
                            </h6>
                            <span class="badge" 
                                  th:classappend="${order.status != null and (#strings.contains(order.status, 'Ho√†n th√†nh') or #strings.contains(order.status, 'Complete'))} ? 'bg-success' : (${order.status != null and #strings.contains(order.status, 'ƒêang x·ª≠ l√Ω')} ? 'bg-warning text-dark' : 'bg-secondary')"
                                  th:text="${order.status ?: 'Ch·ªù x·ª≠ l√Ω'}"></span>
                        </div>
                        <div class="card-body">
                            <!-- Price and Quantity Display -->
                            <div class="row mb-3">
                                <div class="col-6 text-center">
                                    <i class="bi bi-currency-dollar text-primary" style="font-size: 2rem;"></i>
                                    <p class="mb-1 small text-muted">Gi√° ƒë∆°n v·ªã</p>
                                    <p class="fw-bold text-primary">
                                        <span th:text="${#numbers.formatInteger(order.price ?: 0, 0, 'COMMA')}">0</span> VNƒê
                                    </p>
                                </div>
                                <div class="col-6 text-center">
                                    <i class="bi bi-box text-success" style="font-size: 2rem;"></i>
                                    <p class="mb-1 small text-muted">S·ªë l∆∞·ª£ng</p>
                                    <p class="fw-bold text-success">
                                        <span th:text="${order.quantity ?: 0}">0</span> ƒë∆°n v·ªã
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Order Info -->
                            <div class="bg-light p-3 rounded mb-3">
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">üïí Th·ªùi gian ƒë·∫∑t:</small>
                                        <br><small class="fw-bold">
                                            <span th:text="${order.orderTime != null ? #temporals.format(order.orderTime, 'dd/MM/yyyy HH:mm') : 'N/A'}"></span>
                                        </small>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">üë§ Kh√°ch h√†ng:</small>
                                        <br><small class="fw-bold">
                                            <span th:text="${order.customer?.fullName ?: 'N/A'}"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Note Display -->
                            <div th:if="${order.note != null and not #strings.isEmpty(order.note)}">
                                <div class="alert alert-info py-2">
                                    <small><strong>üìù Ghi ch√∫:</strong> <span th:text="${order.note}"></span></small>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <!-- Total Amount and Actions -->
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="total-amount">
                                    <i class="bi bi-cash-stack"></i> T·ªïng: 
                                    <span th:text="${#numbers.formatInteger(order.totalAmount ?: 0, 0, 'COMMA')}">0</span> VNƒê
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm btn-custom" 
                                        th:onclick="|showOrderDetails(${order.id})|">
                                    <i class="bi bi-eye"></i> Chi ti·∫øt
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Summary -->
        <div th:if="${selectedBooking != null}" class="row mt-5">
            <div class="col-12">
                <div class="card payment-summary text-white">
                    <div class="card-body">
                        <h4 class="mb-4 text-center">
                            <i class="bi bi-calculator"></i> üìä T·ªîNG H·ª¢P THANH TO√ÅN
                        </h4>
                        <div class="text-center mb-4">
                            <h5>üè® Booking #<span th:text="${selectedBooking.id}"></span> - Ph√≤ng <span th:text="${selectedBooking.room != null ? selectedBooking.room.name : 'N/A'}"></span></h5>
                            <p class="mb-2">
                                <small class="text-white-50">
                                    üìÖ <span th:text="${selectedBooking.checkIn != null ? #temporals.format(selectedBooking.checkIn, 'dd/MM/yyyy') : 'N/A'}"></span> 
                                    ƒë·∫øn <span th:text="${selectedBooking.checkOut != null ? #temporals.format(selectedBooking.checkOut, 'dd/MM/yyyy') : 'N/A'}"></span>
                                </small>
                            </p>
                            <div class="d-flex justify-content-center gap-2">
                                <a th:href="@{'/booking/invoice/' + ${selectedBooking.id}}" 
                                   class="btn btn-outline-light btn-sm">
                                    <i class="bi bi-receipt"></i> Xem h√≥a ƒë∆°n chi ti·∫øt
                                </a>
                                <a th:href="@{'/booking/details/' + ${selectedBooking.id}}" 
                                   class="btn btn-outline-light btn-sm">
                                    <i class="bi bi-info-circle"></i> Chi ti·∫øt booking
                                </a>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <div class="card bg-white text-dark h-100">
                                    <div class="card-body text-center">
                                        <i class="bi bi-house-door text-primary" style="font-size: 3rem;"></i>
                                        <h6 class="mt-2">üí∞ Ti·ªÅn ph√≤ng</h6>
                                        <h3 class="text-primary mb-0">
                                            <span th:text="${roomTotal != null ? #numbers.formatDecimal(roomTotal, 0, 'COMMA', 0, 'POINT') : '0'}"></span> VNƒê
                                        </h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card bg-white text-dark h-100">
                                    <div class="card-body text-center">
                                        <i class="bi bi-gear text-success" style="font-size: 3rem;"></i>
                                        <h6 class="mt-2">üõéÔ∏è Ti·ªÅn d·ªãch v·ª•</h6>
                                        <h3 class="text-success mb-0">
                                            <span th:text="${totalAmount != null ? #numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT') : '0'}"></span> VNƒê
                                        </h3>
                                        <small class="text-muted">(<span th:text="${orders != null ? orders.size() : 0}"></span> d·ªãch v·ª•)</small>
                                        <div th:if="${canPayServices}" class="mt-2">
                                            <small class="text-success d-block">Ch∆∞a xu·∫•t h√≥a ƒë∆°n cho <strong th:text="${unpaidConfirmedCount}"></strong> d·ªãch v·ª• ƒë√£ x√°c nh·∫≠n.</small>
                                            <small class="text-success">T·ªïng c·∫ßn thanh to√°n: <strong th:text="${#numbers.formatDecimal(unpaidServiceTotal, 0, 'COMMA', 0, 'POINT')}"></strong> VNƒê</small>
                                        </div>
                                        <div th:if="${hasPendingServices}" class="mt-2">
                                            <small class="text-warning"><i class="bi bi-exclamation-triangle"></i> C√≥ d·ªãch v·ª• ƒëang ch·ªù/ƒëang x·ª≠ l√Ω. Vui l√≤ng ƒë·ª£i x√°c nh·∫≠n ƒë·ªÉ thanh to√°n.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center border-top border-light pt-4">
                            <h2 class="mb-4">
                                üèÜ <strong>T·ªîNG C·ªòNG: 
                                <span th:text="${grandTotal != null ? #numbers.formatDecimal(grandTotal, 0, 'COMMA', 0, 'POINT') : (totalAmount != null ? #numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT') : '0')}"></span> VNƒê</strong>
                            </h2>
                            
                            <div class="mb-4">
                                                                <span class="badge fs-5 p-3" 
                                                                            th:classappend="${selectedBooking.status != null and selectedBooking.status == 'ƒê√£ x√°c nh·∫≠n'} ? 'bg-warning text-dark' : (selectedBooking.status != null and selectedBooking.status.contains('thanh to√°n') ? 'bg-success' : 'bg-light text-dark')">
                                                                        <i th:class="${selectedBooking.status != null and selectedBooking.status == 'ƒê√£ x√°c nh·∫≠n'} ? 'bi bi-clock' : (selectedBooking.status != null and selectedBooking.status.contains('thanh to√°n') ? 'bi bi-check-circle' : 'bi bi-info-circle')"></i>
                                                                        <span th:text="${selectedBooking.status}"></span>
                                                                </span>
                            </div>
                            
                            <div class="d-flex flex-wrap justify-content-center gap-3">
                                <!-- N√∫t thanh to√°n -->
                                          <a th:if="${selectedBooking.status != null and selectedBooking.status == 'ƒê√£ x√°c nh·∫≠n' and !(selectedBooking.status != null and selectedBooking.status.contains('thanh to√°n'))}"
                                              th:href="@{'/khachhang/payment/' + ${selectedBooking.id}}" 
                                              class="btn btn-warning btn-lg btn-custom">
                                    <i class="bi bi-credit-card"></i> üí≥ Thanh to√°n ngay
                                </a>
                                
                                <div th:if="${selectedBooking.status != null and selectedBooking.status.contains('thanh to√°n') and (unpaidConfirmedCount == null or unpaidConfirmedCount == 0)}" class="alert alert-success d-inline-block mb-0">
                                    <i class="bi bi-check-circle"></i> ‚úÖ ƒê√£ thanh to√°n to√†n b·ªô!
                                </div>

                                <!-- Thanh to√°n d·ªãch v·ª• sau khi ƒë√£ thanh to√°n ph√≤ng -->
                                <form th:if="${canPayServices}" th:action="@{'/khachhang/payment/' + ${selectedBooking.id} + '/services'}" method="post"
                                      class="d-inline payment-form"
                                      th:data-amount="${unpaidServiceTotal}"
                                      th:data-booking="${selectedBooking.id}">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-light btn-lg btn-custom">
                                        <i class="bi bi-cash-coin"></i> üí≥ Thanh to√°n d·ªãch v·ª• ( <span th:text="${#numbers.formatDecimal(unpaidServiceTotal, 0, 'COMMA', 0, 'POINT')}"></span> VNƒê )
                                    </button>
                                </form>
                                
                                <!-- C√°c n√∫t kh√°c -->
                                <a th:href="@{'/khachhang/services/list?bookingId=' + ${selectedBooking.id}}" 
                                   class="btn btn-primary btn-lg btn-custom">
                                    <i class="bi bi-plus-circle"></i> ‚ûï ƒê·∫∑t th√™m d·ªãch v·ª•
                                </a>
                                
                                <a href="/booking/history" class="btn btn-outline-light btn-lg btn-custom">
                                    <i class="bi bi-clock-history"></i> üìã L·ªãch s·ª≠ booking
                                </a>
                                
                                <a th:href="@{'/booking/invoice/' + ${selectedBooking.id}}" 
                                   class="btn btn-info btn-lg btn-custom">
                                    <i class="bi bi-receipt"></i> üßæ Xem h√≥a ƒë∆°n
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Default Empty State - Ch∆∞a ch·ªçn booking -->
        <div th:if="${selectedBooking == null}" class="row">
            <div class="col-12">
                <div class="empty-state text-center">
                    <i class="bi bi-calendar-check text-primary" style="font-size: 5rem;"></i>
                    <h3 class="mt-4 text-primary">üè® Ch·ªçn booking ƒë·ªÉ b·∫Øt ƒë·∫ßu</h3>
                    <p class="text-muted fs-5">S·ª≠ d·ª•ng dropdown ·ªü tr√™n ƒë·ªÉ ch·ªçn booking b·∫°n mu·ªën qu·∫£n l√Ω d·ªãch v·ª•</p>
                    
                    <div th:if="${paidBookings != null and !paidBookings.empty}" class="alert alert-success d-inline-block">
                        <i class="bi bi-check-circle"></i>
                        üéâ B·∫°n c√≥ <strong th:text="${#lists.size(paidBookings)}"></strong> booking kh·∫£ d·ª•ng ƒë·ªÉ ƒë·∫∑t d·ªãch v·ª•
                    </div>
                    
                    <div th:if="${paidBookings == null or paidBookings.empty}" class="alert alert-warning d-inline-block">
                        <i class="bi bi-exclamation-triangle"></i>
                        ‚ö†Ô∏è B·∫°n ch∆∞a c√≥ booking n√†o ƒë∆∞·ª£c x√°c nh·∫≠n ho·∫∑c ƒë√£ thanh to√°n
                        <br><small class="mt-2 d-block">Vui l√≤ng ƒë·∫∑t ph√≤ng tr∆∞·ªõc khi s·ª≠ d·ª•ng d·ªãch v·ª•</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Single Reusable Modal for order details -->
    <div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="orderModalLabel">
                        <i class="bi bi-info-circle"></i> Chi ti·∫øt d·ªãch v·ª•: <span id="modalOrderServiceName">-</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            <table class="table table-bordered table-striped">
                                <tr>
                                    <th class="bg-light">üõéÔ∏è T√™n d·ªãch v·ª•</th>
                                    <td id="modalOrderService">-</td>
                                </tr>
                                <tr>
                                    <th class="bg-light">üí∞ Gi√° ƒë∆°n v·ªã</th>
                                    <td id="modalOrderPrice">-</td>
                                </tr>
                                <tr>
                                    <th class="bg-light">üì¶ S·ªë l∆∞·ª£ng</th>
                                    <td id="modalOrderQuantity">-</td>
                                </tr>
                                <tr>
                                    <th class="bg-light">üíµ T·ªïng ti·ªÅn</th>
                                    <td class="fw-bold text-success fs-5" id="modalOrderTotal">-</td>
                                </tr>
                                <tr>
                                    <th class="bg-light">üë§ Kh√°ch h√†ng</th>
                                    <td id="modalOrderCustomer">-</td>
                                </tr>
                                <tr>
                                    <th class="bg-light">üìû S·ªë ƒëi·ªán tho·∫°i</th>
                                    <td id="modalOrderPhone">-</td>
                                </tr>
                                <tr>
                                    <th class="bg-light">üïí Th·ªùi gian ƒë·∫∑t</th>
                                    <td id="modalOrderTime">-</td>
                                </tr>
                                <tr>
                                    <th class="bg-light">üìä Tr·∫°ng th√°i</th>
                                    <td>
                                        <span class="badge fs-6 p-2" id="modalOrderStatus">-</span>
                                    </td>
                                </tr>
                                <tr id="modalUpdatedAtRow" style="display:none;">
                                    <th class="bg-light">üïí C·∫≠p nh·∫≠t g·∫ßn nh·∫•t</th>
                                    <td id="modalUpdatedAt">-</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div id="modalOrderNoteSection" class="mt-4" style="display: none;">
                        <h6 class="text-primary"><i class="bi bi-sticky"></i> Ghi ch√∫ t·ª´ kh√°ch h√†ng</h6>
                        <div class="alert alert-info" id="modalOrderNote">-</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> ƒê√≥ng
                    </button>
                    <form id="modalCancelForm" method="post" class="d-inline" style="display: none;"
                          onsubmit="return confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy d·ªãch v·ª• n√†y kh√¥ng?')">
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash"></i> H·ªßy d·ªãch v·ª•
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Format number with Vietnamese locale
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' VNƒê';
        }
        
        // Helper utilities
        function setTextById(id, text) {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = text != null && text !== '' ? text : '-';
        }

        function setHtmlById(id, html) {
            const el = document.getElementById(id);
            if (!el) return;
            el.innerHTML = html != null && html !== '' ? html : '-';
        }

        function toggleRow(rowId, elId, value) {
            const row = document.getElementById(rowId);
            const el = document.getElementById(elId);
            if (!row || !el) return;
            if (value && value.toString().trim() !== '') {
                el.textContent = value;
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }

        function applyStatusBadgeClass(el, status) {
            if (!el) return;
            el.textContent = status != null && status !== '' ? status : '-';
            el.className = 'badge fs-6 p-2';
            if (status && status.includes('ƒêang x·ª≠ l√Ω')) {
                el.classList.add('bg-warning', 'text-dark');
            } else if (status && status.includes('Ho√†n th√†nh')) {
                el.classList.add('bg-success');
            } else if (status && (status.toLowerCase().includes('huy') || status.toLowerCase().includes('h·ªßy')) ) {
                el.classList.add('bg-danger');
            } else {
                el.classList.add('bg-secondary');
            }
        }

        // Show order details in single modal (simplified)
        function showOrderDetails(button) {
            const orderId = button.dataset.orderId;
            setTextById('modalOrderServiceName', button.dataset.serviceName);
            setTextById('modalOrderService', button.dataset.serviceName);
            setHtmlById('modalOrderPrice', `<span class="fw-bold text-primary">${formatCurrency(parseInt(button.dataset.price) || 0)}</span>`);
            setHtmlById('modalOrderQuantity', `<span class="badge bg-success fs-6">${button.dataset.quantity || 0}</span> ƒë∆°n v·ªã`);
            setTextById('modalOrderTotal', formatCurrency(parseInt(button.dataset.total) || 0));
            setTextById('modalOrderCustomer', button.dataset.customer);
            setTextById('modalOrderPhone', button.dataset.phone);
            setTextById('modalOrderTime', button.dataset.time);

            applyStatusBadgeClass(document.getElementById('modalOrderStatus'), button.dataset.status);

            // Note only (removed admin fields)
            toggleRow('modalOrderNoteSection', 'modalOrderNote', button.dataset.note);

            // Cancel form visibility
            const cancelForm = document.getElementById('modalCancelForm');
            if (cancelForm) {
                if (button.dataset.status && button.dataset.status.includes('ƒêang x·ª≠ l√Ω')) {
                    cancelForm.action = `/khachhang/services/cancel/${orderId}`;
                    cancelForm.style.display = 'inline';
                } else {
                    cancelForm.style.display = 'none';
                }
            }

            const modal = new bootstrap.Modal(document.getElementById('orderModal'));
            modal.show();
        }
        
        // Simple DOM loaded handler - no complex auto refresh or lazy loading
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, making all order cards visible');
            // Make all cards visible immediately without animations
            document.querySelectorAll('.order-card').forEach(function(card) {
                card.style.opacity = '1';
                card.style.transform = 'none';
            });
        });

        // ===== SIMPLE AND RELIABLE APPROACH =====
        // No more complex AJAX - just use normal form submit with loading overlay
        document.addEventListener('DOMContentLoaded', function(){
            console.log('Simple booking selection script loaded');
            
            // Create simple loading overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(255,255,255,0.9); z-index: 9999; display: none;
                align-items: center; justify-content: center; flex-direction: column;
            `;
            overlay.innerHTML = `
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
                <h4 class="text-primary">ƒêang t·∫£i d·ªØ li·ªáu...</h4>
                <p class="text-muted">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
            `;
            document.body.appendChild(overlay);

            const select = document.getElementById('bookingSelect');
            const form = select ? select.form : null;
            const submitBtn = document.getElementById('bookingSubmitBtn');

            // Simple change handler with form submit
            let timeoutId;
            if (select && form) {
                select.addEventListener('change', function(){
                    clearTimeout(timeoutId);
                    const bookingId = select.value;
                    
                    if (bookingId) {
                        console.log('Booking selected:', bookingId, 'submitting form...');
                        // Small delay then submit form normally
                        timeoutId = setTimeout(function(){
                            overlay.style.display = 'flex';
                            if (submitBtn) submitBtn.disabled = true;
                            form.submit();
                        }, 500);
                    }
                });
            }

            // Handle form submit
            if (form) {
                form.addEventListener('submit', function(){
                    console.log('Form submitted, showing loading...');
                    overlay.style.display = 'flex';
                    if (submitBtn) submitBtn.disabled = true;
                });
            }

            // Ensure order cards are visible immediately
            setTimeout(function(){
                document.querySelectorAll('.order-card').forEach(function(card){
                    card.classList.add('loaded');
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                    card.style.transition = 'none'; // Remove transitions that might cause issues
                });
                console.log('Order cards made visible');
            }, 100);

            // Auto-hide overlay after reasonable time (fallback)
            setTimeout(function(){
                overlay.style.display = 'none';
                if (submitBtn) submitBtn.disabled = false;
                console.log('Loading overlay auto-hidden');
            }, 2000);
        });
    </script>
</body>
</html>

<!-- Confirmation Modal (shared) -->
<div class="modal fade" id="confirmPaymentModal" tabindex="-1" aria-labelledby="confirmPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmPaymentModalLabel">X√°c nh·∫≠n thanh to√°n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmPaymentMessage">B·∫°n c√≥ ch·∫Øc mu·ªën thanh to√°n s·ªë ti·ªÅn <strong id="confirmAmount">0 VNƒê</strong> cho booking <strong id="confirmBooking">#0</strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="confirmPaymentBtn">X√°c nh·∫≠n v√† thanh to√°n</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function(){
        let activeForm = null;
        const modalEl = document.getElementById('confirmPaymentModal');
        if (!modalEl) return;
        const bsModal = new bootstrap.Modal(modalEl);
        const amountEl = document.getElementById('confirmAmount');
        const bookingEl = document.getElementById('confirmBooking');
        const confirmBtn = document.getElementById('confirmPaymentBtn');

        document.querySelectorAll('.payment-form').forEach(function(form){
            form.addEventListener('submit', function(e){
                e.preventDefault();
                activeForm = form;
                const amount = form.getAttribute('data-amount') || form.dataset.amount || 0;
                const bookingId = form.getAttribute('data-booking') || form.dataset.booking || '';
                const fmt = new Intl.NumberFormat('vi-VN');
                amountEl.textContent = fmt.format(Number(amount || 0)) + ' VNƒê';
                bookingEl.textContent = '#' + bookingId;
                bsModal.show();
            });
        });

        if (confirmBtn) {
            confirmBtn.addEventListener('click', function(){
                if (!activeForm) return;
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> ƒêang x·ª≠ l√Ω...';
                bsModal.hide();
                setTimeout(function(){ activeForm.submit(); }, 150);
            });
        }
    })();
</script>
